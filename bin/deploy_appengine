#!/usr/bin/env bash
# Copyright (C) 2019 Google Inc.
# Licensed under http://www.apache.org/licenses/LICENSE-2.0 <see LICENSE file>

SCRIPTPATH=$( cd "$(dirname "$0")" ; pwd -P )

if [[ -z "$1" ]]
then
  echo "Usage: `basename ${0}` <deployment_settings_files>"
  exit
fi

cd "${SCRIPTPATH}/.."
source "bin/init_env"
for settings_file in "$@"
do
  source "$settings_file"
done

set -o nounset

make clean_deploy
make deploy \
	APPENGINE_INSTANCE="${APPENGINE_INSTANCE}" \
	SETTINGS_MODULE="${SETTINGS_MODULE}" \
	DATABASE_URI="${DATABASE_URI}" \
	SECRET_KEY="${SECRET_KEY}" \
	GOOGLE_ANALYTICS_ID="${GOOGLE_ANALYTICS_ID}" \
	GOOGLE_ANALYTICS_DOMAIN="${GOOGLE_ANALYTICS_DOMAIN}" \
	GAPI_KEY="${GAPI_KEY}" \
	GAPI_CLIENT_ID="${GAPI_CLIENT_ID}" \
	GAPI_CLIENT_SECRET="${GAPI_CLIENT_SECRET}" \
	GAPI_ADMIN_GROUP="${GAPI_ADMIN_GROUP}" \
	BOOTSTRAP_ADMIN_USERS="${BOOTSTRAP_ADMIN_USERS}" \
	MIGRATOR="${MIGRATOR}" \
	RISK_ASSESSMENT_URL="${RISK_ASSESSMENT_URL}" \
	ASSESSMENT_SHORT_URL_PREFIX="${ASSESSMENT_SHORT_URL_PREFIX}" \
	NOTIFICATION_PREFIX="${NOTIFICATION_PREFIX}" \
	DAILY_DIGEST_BATCH_SIZE="${DAILY_DIGEST_BATCH_SIZE}" \
	APPENGINE_EMAIL="${APPENGINE_EMAIL}" \
	CUSTOM_URL_ROOT="${CUSTOM_URL_ROOT}" \
	ABOUT_URL="${ABOUT_URL}" \
	ABOUT_TEXT="${ABOUT_TEXT}" \
	EXTERNAL_HELP_URL="${EXTERNAL_HELP_URL}" \
	EXTERNAL_IMPORT_HELP_URL="${EXTERNAL_IMPORT_HELP_URL}" \
	INSTANCE_CLASS="${INSTANCE_CLASS}" \
	MAX_INSTANCES="${MAX_INSTANCES}" \
	SCALING="${SCALING}" \
	AUTHORIZED_DOMAIN="${AUTHORIZED_DOMAIN}" \
	GGRC_Q_INTEGRATION_URL="${GGRC_Q_INTEGRATION_URL}" \
	INTEGRATION_SERVICE_URL="${INTEGRATION_SERVICE_URL}" \
	EXTERNAL_APP_USER="${EXTERNAL_APP_USER}" \
	URLFETCH_SERVICE_ID="${URLFETCH_SERVICE_ID}" \
	ISSUE_TRACKER_ENABLED="${ISSUE_TRACKER_ENABLED}" \
	ISSUE_TRACKER_BUG_URL_TMPL="${ISSUE_TRACKER_BUG_URL_TMPL}" \
	DASHBOARD_INTEGRATION="${DASHBOARD_INTEGRATION}" \
	ACCESS_TOKEN="${ACCESS_TOKEN}" \
	ALLOWED_QUERYAPI_APP_IDS="${ALLOWED_QUERYAPI_APP_IDS}" \
	COMPANY="${COMPANY}" \
	COMPANY_LOGO_TEXT="${COMPANY_LOGO_TEXT}" \
	CREATE_ISSUE_URL="${CREATE_ISSUE_URL}" \
	CREATE_ISSUE_BUTTON_NAME="${CREATE_ISSUE_BUTTON_NAME}" \
	APPENGINE_LOCATION="${APPENGINE_LOCATION}" \
	CHANGE_REQUEST_URL="${CHANGE_REQUEST_URL}"
